<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Connect by Right Solutions A.I.</title>
    <link rel="icon" href="s1.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1976d2;
            --secondary: #42a5f5;
            --background: #f5f5f5;
            --card-bg: #ffffff;
            --text: #212121;
            --accent: #0288d1;
        }
        .dark {
            --background: #212121;
            --card-bg: #424242;
            --text: #e0e0e0;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) #e0e0e0;
            font-size: 14px;
            overscroll-behavior: none;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            overflow: hidden;
        }
        .content {
            flex: 1;
            padding: 0.5rem;
            overflow-y: auto;
            padding-bottom: 4rem; /* Space for bottom nav */
        }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .btn {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.3s, transform 0.2s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            text-align: center;
            font-size: 0.875rem;
        }
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .btn:hover::after {
            width: 200px;
            height: 200px;
        }
        .btn:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }
        .btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }
        input, select, textarea {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.5rem;
            width: 100%;
            margin-bottom: 0.5rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 0.875rem;
        }
        .dark input, .dark select, .dark textarea {
            background: #616161;
            border-color: #757575;
            color: var(--text);
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
            outline: none;
        }
        input.error, select.error {
            border-color: #d32f2f;
            animation: shake 0.3s;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 10;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }
        .nav-item.active, .nav-item:hover {
            color: var(--primary);
        }
        .nav-item img {
            width: 20px;
            height: 20px;
            margin-bottom: 0.25rem;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1rem;
            max-width: 90%;
            width: 300px;
            animation: slideIn 0.3s;
        }
        .toast {
            position: fixed;
            bottom: 4.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: #4caf50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
            font-size: 0.75rem;
            max-width: 90%;
            text-align: center;
        }
        .toast.show { opacity: 1; }
        .progress-bar {
            height: 3px;
            background: var(--primary);
            transition: width 0.3s;
        }
        .progress-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .dark .progress-circle {
            border-color: #616161;
            border-top-color: var(--primary);
        }
        .fab {
            position: fixed;
            bottom: 5rem;
            right: 0.5rem;
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 1.25rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @media (min-width: 640px) {
            .container { max-width: 640px; margin: 0 auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Content -->
        <div class="content">
            <!-- Loading Screen -->
            <div id="loadingScreen" class="screen flex items-center justify-center h-full">
                <div class="progress-circle"></div>
            </div>

            <!-- Signup Screen -->
            <div id="signupScreen" class="screen card">
                <h2 class="text-base font-bold mb-3">Sign Up</h2>
                <div class="progress-bar" style="width: 33%"></div>
                <input id="nameInput" type="text" placeholder="Full Name" aria-label="Full Name">
                <input id="birthYearInput" type="number" placeholder="Birth Year" aria-label="Birth Year">
                <select id="caseTypeInput" aria-label="Case Type">
                    <option value="" disabled selected>Select Case Type</option>
                    <option value="Civil">Civil</option>
                    <option value="Criminal">Criminal</option>
                    <option value="Family">Family</option>
                    <option value="Corporate">Corporate</option>
                </select>
                <button id="signupBtn" class="btn w-full" disabled>Sign Up</button>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen">
                <h2 class="text-base font-bold mb-3">Dashboard</h2>
                <div class="card">
                    <div class="flex items-center">
                        <div id="userAvatar" class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center text-lg mr-3"></div>
                        <div>
                            <p id="welcomeMsg" class="text-xs"></p>
                            <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                                <div id="profileProgress" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs">Profile Completeness</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-sm font-bold mb-2">Quick Actions</h3>
                    <button id="onlineBtn" class="btn w-full mb-2">Meet Lawyer Online</button>
                    <button id="nearbyBtn" class="btn w-full mb-2">Find Lawyer Nearby</button>
                    <button id="profileBtn" class="btn w-full">Edit Profile</button>
                </div>
                <div class="card">
                    <h3 class="text-sm font-bold mb-2">Recent Appointments</h3>
                    <div id="recentAppointments" class="text-xs"></div>
                </div>
            </div>

            <!-- Location Screen -->
            <div id="locationScreen" class="screen card">
                <h2 class="text-base font-bold mb-3">Select Your District</h2>
                <div class="progress-bar" style="width: 66%"></div>
                <input id="districtInput" type="text" list="districtList" placeholder="Type or select district" aria-label="District">
                <datalist id="districtList">
                    <option value="Alappuzha">
                    <option value="Ernakulam">
                    <option value="Idukki">
                    <option value="Kannur">
                    <option value="Kasaragod">
                    <option value="Kollam">
                    <option value="Kottayam">
                    <option value="Kozhikode">
                    <option value="Malappuram">
                    <option value="Palakkad">
                    <option value="Pathanamthitta">
                    <option value="Thiruvananthapuram">
                    <option value="Thrissur">
                    <option value="Wayanad">
                </datalist>
                <button id="getLocationBtn" class="btn w-full mb-2">Use My Location</button>
                <button id="submitDistrictBtn" class="btn w-full">Submit</button>
            </div>

            <!-- Lawyer Screen -->
            <div id="lawyerScreen" class="screen card">
                <h2 class="text-base font-bold mb-3">Available Lawyer</h2>
                <p id="noLawyerMsg" class="text-xs text-center mb-3 hidden">No legal professionals available in this district.</p>
                <div id="lawyerInfo">
                    <div class="card">
                        <p class="text-xs"><strong>Name:</strong> Gayathri</p>
                        <p class="text-xs"><strong>Location:</strong> Alappuzha District Court</p>
                        <p class="text-xs"><strong>Status:</strong> <span id="lawyerStatus">Available Now</span></p>
                        <p class="text-xs"><strong>Rating:</strong> 5.0 (80 reviews)</p>
                        <button id="viewLawyerProfile" class="btn w-full mt-2">View Profile</button>
                        <select id="timeSlotInput" aria-label="Select Time Slot" class="mt-2">
                            <option value="" disabled selected>Select Time Slot</option>
                        </select>
                        <textarea id="notesInput" placeholder="Add Notes (Optional)" class="h-16 text-xs" aria-label="Notes"></textarea>
                        <label class="flex items-center mb-2 text-xs">
                            <input type="checkbox" id="priorityInput" class="mr-2"> High Priority
                        </label>
                        <input id="attachmentInput" type="file" accept="image/*,application/pdf" aria-label="Attachment">
                        <button id="bookBtn" class="btn w-full mt-2" disabled>Book Appointment</button>
                    </div>
                </div>
            </div>

            <!-- Online Booking Screen -->
            <div id="onlineScreen" class="screen card">
                <h2 class="text-base font-bold mb-3">Book Online Appointment</h2>
                <div class="progress-bar" style="width: 100%"></div>
                <select id="onlineCaseType" aria-label="Case Type">
                    <option value="" disabled selected>Select Case Type</option>
                    <option value="Civil">Civil</option>
                    <option value="Criminal">Criminal</option>
                    <option value="Family">Family</option>
                    <option value="Corporate">Corporate</option>
                </select>
                <select id="conferenceMethod" aria-label="Conference Method">
                    <option value="" disabled selected>Select Conference Method</option>
                    <option value="Call">Call</option>
                    <option value="WhatsApp Video">WhatsApp Video</option>
                    <option value="Zoom">Zoom</option>
                    <option value="Google Meet">Google Meet</option>
                    <option value="Chat">Chat</option>
                </select>
                <select id="timeSlotInputOnline" aria-label="Select Time Slot">
                    <option value="" disabled selected>Select Time Slot</option>
                </select>
                <textarea id="notesInputOnline" placeholder="Add Notes (Optional)" class="h-16 text-xs" aria-label="Notes"></textarea>
                <label class="flex items-center mb-2 text-xs">
                    <input type="checkbox" id="recurringInput" class="mr-2"> Recurring Appointment
                </label>
                <input id="attachmentInputOnline" type="file" accept="image/*,application/pdf" aria-label="Attachment">
                <button id="bookOnlineBtn" class="btn w-full" disabled>Book Appointment</button>
            </div>

            <!-- Profile Screen -->
            <div id="profileScreen" class="screen card">
                <h2 class="text-base font-bold mb-3">Your Profile</h2>
                <div id="userAvatar" class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center text-xl mb-3"></div>
                <input id="editNameInput" type="text" placeholder="Full Name" aria-label="Edit Name">
                <input id="editBirthYearInput" type="number" placeholder="Birth Year" aria-label="Edit Birth Year">
                <select id="editCaseTypeInput" aria-label="Edit Case Type">
                    <option value="" disabled selected>Select Case Type</option>
                    <option value="Civil">Civil</option>
                    <option value="Criminal">Criminal</option>
                    <option value="Family">Family</option>
                    <option value="Corporate">Corporate</option>
                </select>
                <input id="profilePicInput" type="file" accept="image/*" aria-label="Profile Picture">
                <select id="languageSelect" aria-label="Language">
                    <option value="en">English</option>
                    <option value="ml">Malayalam</option>
                    <option value="hi">Hindi</option>
                </select>
                <select id="fontSizeSelect" aria-label="Font Size">
                    <option value="14">Normal</option>
                    <option value="16">Large</option>
                    <option value="18">Extra Large</option>
                </select>
                <button id="saveProfileBtn" class="btn w-full">Save Changes</button>
            </div>

            <!-- Appointments Screen -->
            <div id="appointmentsScreen" class="screen card">
                <h2 class="text-base font-bold mb-3">Your Appointments</h2>
                <input id="searchAppointments" type="text" placeholder="Search by case type or date" aria-label="Search Appointments">
                <select id="filterAppointments" aria-label="Filter Appointments">
                    <option value="All">All</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Pending">Pending</option>
                    <option value="Cancelled">Cancelled</option>
                    <option value="Completed">Completed</option>
                </select>
                <div id="appointmentsList" class="mt-3"></div>
                <button id="exportAppointmentsBtn" class="btn w-full mt-2">Export as CSV</button>
            </div>

            <!-- Confirmation Screen -->
            <div id="confirmationScreen" class="screen card text-center">
                <h2 class="text-base font-bold mb-3">Appointment Booked!</h2>
                <div id="handshakeAnimation" class="w-24 h-24 mx-auto"></div>
                <p class="text-xs mb-3">Your appointment has been confirmed.</p>
                <button id="previewPDFBtn" class="btn w-full mb-2">Preview PDF</button>
                <button id="viewAppointmentsBtn" class="btn w-full">View Appointments</button>
            </div>

            <!-- PDF Preview Screen -->
            <div id="pdfPreviewScreen" class="screen card">
                <h2 class="text-base font-bold mb-3">PDF Preview</h2>
                <div id="pdfPreview" class="border p-3"></div>
                <button id="downloadPDFBtn" class="btn w-full mt-2">Download PDF</button>
                <button id="backPDFBtn" class="btn w-full mt-2">Back</button>
            </div>

            <!-- Modal -->
            <div id="modal" class="modal">
                <div class="modal-content">
                    <p id="modalMessage" class="mb-3 text-xs"></p>
                    <div class="flex justify-end gap-2">
                        <button id="modalCancel" class="btn">Cancel</button>
                        <button id="modalConfirm" class="btn">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item" data-screen="dashboardScreen">
                <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231976d2'><path d='M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z'/></svg>" alt="Dashboard">
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-screen="appointmentsScreen">
                <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231976d2'><path d='M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.89-1.99 2L3 19c0 1.11.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z'/></svg>" alt="Appointments">
                <span>Appointments</span>
            </div>
            <div class="nav-item" data-screen="profileScreen">
                <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231976d2'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>" alt="Profile">
                <span>Profile</span>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab" id="fab">➕</div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        const { jsPDF } = window.jspdf;

        // Screen management
        const screens = document.querySelectorAll('.screen');
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('loadingScreen').classList.add('active');
            setTimeout(() => document.getElementById('loadingScreen').classList.remove('active'), 300);
            localStorage.setItem('lastScreen', screenId);
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.screen === screenId);
            });
        }

        // Toast notifications
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Modal
        function showModal(message, onConfirm) {
            const modal = document.getElementById('modal');
            document.getElementById('modalMessage').textContent = message;
            modal.classList.add('active');
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');
            const handler = () => {
                modal.classList.remove('active');
                onConfirm();
                confirmBtn.removeEventListener('click', handler);
            };
            confirmBtn.addEventListener('click', handler);
            cancelBtn.addEventListener('click', () => modal.classList.remove('active'));
        }

        // Handshake animation
        function loadHandshakeAnimation() {
            lottie.loadAnimation({
                container: document.getElementById('handshakeAnimation'),
                renderer: 'svg',
                loop: false,
                autoplay: true,
                path: 'https://assets9.lottiefiles.com/packages/lf20_jbrw3hsa.json'
            });
        }

        // Local storage and user data
        let userData = JSON.parse(localStorage.getItem('userData'));
        if (userData) {
            showScreen(localStorage.getItem('lastScreen') || 'dashboardScreen');
            updateAvatar();
            updateProfileProgress();
            document.getElementById('welcomeMsg').textContent = `Welcome, ${userData.name}!`;
        } else {
            showScreen('signupScreen');
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark');
        }

        // Input validation
        function validateInputs(inputs, button) {
            const allFilled = Array.from(inputs).every(input => input.value);
            button.disabled = !allFilled;
            inputs.forEach(input => {
                input.classList.remove('error');
                if (!input.value) input.classList.add('error');
            });
        }

        // Signup validation
        const signupInputs = [document.getElementById('nameInput'), document.getElementById('birthYearInput'), document.getElementById('caseTypeInput')];
        signupInputs.forEach(input => input.addEventListener('input', () => validateInputs(signupInputs, document.getElementById('signupBtn'))));

        // Online booking validation
        const onlineInputs = [document.getElementById('onlineCaseType'), document.getElementById('conferenceMethod'), document.getElementById('timeSlotInputOnline')];
        onlineInputs.forEach(input => input.addEventListener('input', () => validateInputs(onlineInputs, document.getElementById('bookOnlineBtn'))));

        // Lawyer booking validation
        const lawyerInputs = [document.getElementById('timeSlotInput')];
        lawyerInputs.forEach(input => input.addEventListener('input', () => validateInputs(lawyerInputs, document.getElementById('bookBtn'))));

        // Avatar generation
        function updateAvatar() {
            const avatars = document.querySelectorAll('#userAvatar');
            avatars.forEach(avatar => {
                if (userData.profilePic) {
                    avatar.style.backgroundImage = `url(${userData.profilePic})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.textContent = '';
                } else if (userData) {
                    avatar.textContent = userData.name.charAt(0).toUpperCase();
                }
            });
        }

        // Profile progress
        function updateProfileProgress() {
            const fields = ['name', 'birthYear', 'caseType', 'profilePic', 'language', 'fontSize'];
            const filled = fields.filter(field => userData[field]).length;
            const progress = (filled / fields.length) * 100;
            document.getElementById('profileProgress').style.width = `${progress}%`;
        }

        // Generate time slots
        function generateTimeSlots(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="" disabled selected>Select Time Slot</option>';
            const now = new Date();
            for (let i = 1; i <= 7; i++) {
                const date = new Date(now.getTime() + i * 24 * 60 * 60 * 1000);
                ['10:00', '14:00', '16:00'].forEach(time => {
                    const value = `${date.toISOString().split('T')[0]}T${time}`;
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = `${date.toLocaleDateString()} ${time}`;
                    select.appendChild(option);
                });
            }
        }
        generateTimeSlots('timeSlotInput');
        generateTimeSlots('timeSlotInputOnline');

        // Bottom navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const screen = item.dataset.screen;
                showScreen(screen);
                if (screen === 'appointmentsScreen') displayAppointments();
            });
        });

        // Signup
        document.getElementById('signupBtn').addEventListener('click', () => {
            const name = document.getElementById('nameInput').value;
            const birthYear = document.getElementById('birthYearInput').value;
            const caseType = document.getElementById('caseTypeInput').value;
            if (!name.match(/^[A-Za-z\s]{2,}$/)) {
                showToast('Invalid name');
                document.getElementById('nameInput').classList.add('error');
                return;
            }
            if (birthYear < 1900 || birthYear > new Date().getFullYear()) {
                showToast('Invalid birth year');
                document.getElementById('birthYearInput').classList.add('error');
                return;
            }
            userData = { name, birthYear, caseType, language: 'en', fontSize: '14' };
            localStorage.setItem('userData', JSON.stringify(userData));
            updateAvatar();
            updateProfileProgress();
            showScreen('dashboardScreen');
            document.getElementById('welcomeMsg').textContent = `Welcome, ${userData.name}!`;
            showToast('Signup successful!');
            logActivity('User signed up');
        });

        // Navigation
        document.getElementById('onlineBtn').addEventListener('click', () => showScreen('onlineScreen'));
        document.getElementById('nearbyBtn').addEventListener('click', () => showScreen('locationScreen'));
        document.getElementById('profileBtn').addEventListener('click', () => {
            document.getElementById('editNameInput').value = userData.name;
            document.getElementById('editBirthYearInput').value = userData.birthYear;
            document.getElementById('editCaseTypeInput').value = userData.caseType;
            document.getElementById('languageSelect').value = userData.language || 'en';
            document.getElementById('fontSizeSelect').value = userData.fontSize || '14';
            showScreen('profileScreen');
        });

        // Location selection
        document.getElementById('submitDistrictBtn').addEventListener('click', () => {
            const district = document.getElementById('districtInput').value;
            if (!district) {
                showToast('Please select a district');
                document.getElementById('districtInput').classList.add('error');
                return;
            }
            showScreen('lawyerScreen');
            const noLawyerMsg = document.getElementById('noLawyerMsg');
            const lawyerInfo = document.getElementById('lawyerInfo');
            if (district === 'Alappuzha') {
                noLawyerMsg.classList.add('hidden');
                lawyerInfo.classList.remove('hidden');
                document.getElementById('lawyerStatus').textContent = new Date().getHours() < 17 ? 'Available Now' : 'Available Tomorrow';
            } else {
                noLawyerMsg.classList.remove('hidden');
                lawyerInfo.classList.add('hidden');
            }
            logActivity(`Selected district: ${district}`);
        });

        // Geo-location
        document.getElementById('getLocationBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(() => {
                    document.getElementById('districtInput').value = 'Alappuzha';
                    showToast('Location detected: Alappuzha');
                }, () => showToast('Location access denied'));
            } else {
                showToast('Geolocation not supported');
            }
        });

        // Lawyer profile
        document.getElementById('viewLawyerProfile').addEventListener('click', () => showScreen('lawyerProfileScreen'));

        // Book nearby appointment
        let currentAppointment;
        document.getElementById('bookBtn').addEventListener('click', () => {
            const timeSlot = document.getElementById('timeSlotInput').value;
            const notes = escapingHTML(document.getElementById('notesInput').value);
            const priority = document.getElementById('priorityInput').checked;
            const attachment = document.getElementById('attachmentInput').files[0];
            if (!timeSlot) {
                showToast('Please select a time slot');
                document.getElementById('timeSlotInput').classList.add('error');
                return;
            }
            showModal('Confirm booking?', () => {
                const reader = new FileReader();
                reader.onload = () => {
                    currentAppointment = {
                        id: Date.now(),
                        lawyer: 'Gayathri',
                        location: 'Alappuzha District Court',
                        caseType: userData.caseType,
                        dateTime: timeSlot,
                        status: 'Confirmed',
                        notes,
                        tags: priority ? ['Urgent', 'Priority'] : ['Urgent'],
                        attachment: reader.result || null
                    };
                    if (saveAppointment(currentAppointment)) {
                        generatePDF(currentAppointment);
                        showScreen('confirmationScreen');
                        loadHandshakeAnimation();
                        showToast('Appointment booked!');
                        logActivity('Booked nearby appointment');
                        updateRecentAppointments();
                    }
                };
                if (attachment) reader.readAsDataURL(attachment);
                else reader.onload();
            });
        });

        // Book online appointment
        document.getElementById('bookOnlineBtn').addEventListener('click', () => {
            const caseType = document.getElementById('onlineCaseType').value;
            const conferenceMethod = document.getElementById('conferenceMethod').value;
            const timeSlot = document.getElementById('timeSlotInputOnline').value;
            const notes = escapingHTML(document.getElementById('notesInputOnline').value);
            const recurring = document.getElementById('recurringInput').checked;
            const attachment = document.getElementById('attachmentInputOnline').files[0];
            if (!caseType || !conferenceMethod || !timeSlot) {
                showToast('Please fill all required fields');
                return;
            }
            showModal('Confirm booking?', () => {
                const reader = new FileReader();
                reader.onload = () => {
                    currentAppointment = {
                        id: Date.now(),
                        lawyer: 'Gayathri',
                        location: 'Online - Alappuzha',
                        caseType,
                        conferenceMethod,
                        dateTime: timeSlot,
                        status: 'Confirmed',
                        notes,
                        tags: recurring ? ['Online', 'Recurring'] : ['Online'],
                        attachment: reader.result || null
                    };
                    if (saveAppointment(currentAppointment)) {
                        generatePDF(currentAppointment);
                        showScreen('confirmationScreen');
                        loadHandshakeAnimation();
                        showToast('Appointment booked!');
                        logActivity('Booked online appointment');
                        updateRecentAppointments();
                    }
                };
                if (attachment) reader.readAsDataURL(attachment);
                else reader.onload();
            });
        });

        // Save profile
        document.getElementById('saveProfileBtn').addEventListener('click', () => {
            const name = document.getElementById('editNameInput').value;
            const birthYear = document.getElementById('editBirthYearInput').value;
            const caseType = document.getElementById('editCaseTypeInput').value;
            const language = document.getElementById('languageSelect').value;
            const fontSize = document.getElementById('fontSizeSelect').value;
            if (!name.match(/^[A-Za-z\s]{2,}$/)) {
                showToast('Invalid name');
                document.getElementById('editNameInput').classList.add('error');
                return;
            }
            if (birthYear < 1900 || birthYear > new Date().getFullYear()) {
                showToast('Invalid birth year');
                document.getElementById('editBirthYearInput').classList.add('error');
                return;
            }
            userData = { ...userData, name, birthYear, caseType, language, fontSize };
            localStorage.setItem('userData', JSON.stringify(userData));
            document.body.style.fontSize = `${fontSize}px`;
            updateAvatar();
            updateProfileProgress();
            showScreen('dashboardScreen');
            showToast('Profile updated!');
            logActivity('Updated profile');
        });

        // Profile picture upload
        document.getElementById('profilePicInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    userData.profilePic = reader.result;
                    localStorage.setItem('userData', JSON.stringify(userData));
                    updateAvatar();
                    updateProfileProgress();
                };
                reader.readAsDataURL(file);
            }
        });

        // Save appointment
        function saveAppointment(appointment) {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            if (appointments.length >= 10) {
                showToast('Booking limit reached (10 appointments)');
                return false;
            }
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            return true;
        }

        // Display appointments
        function displayAppointments() {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const filter = document.getElementById('filterAppointments').value;
            const search = document.getElementById('searchAppointments').value.toLowerCase();
            let filtered = appointments.filter(apt => filter === 'All' || apt.status === filter);
            filtered = filtered.filter(apt => 
                apt.caseType.toLowerCase().includes(search) || 
                new Date(apt.dateTime).toLocaleString().toLowerCase().includes(search)
            );
            filtered.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            const list = document.getElementById('appointmentsList');
            list.innerHTML = '';
            filtered.forEach(apt => {
                const div = document.createElement('div');
                div.className = 'p-2 border rounded mb-2 card';
                div.innerHTML = `
                    <p class="text-xs"><strong>Lawyer:</strong> ${apt.lawyer}</p>
                    <p class="text-xs"><strong>Location:</strong> ${apt.location}</p>
                    <p class="text-xs"><strong>Case Type:</strong> ${apt.caseType}</p>
                    <p class="text-xs"><strong>Date:</strong> ${new Date(apt.dateTime).toLocaleString()}</p>
                    ${apt.conferenceMethod ? `<p class="text-xs"><strong>Method:</strong> ${apt.conferenceMethod}</p>` : ''}
                    ${apt.notes ? `<p class="text-xs"><strong>Notes:</strong> ${apt.notes}</p>` : ''}
                    <p class="text-xs"><strong>Status:</strong> ${apt.status}</p>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button class="btn text-xs" onclick="cancelAppointment(${apt.id})">Cancel</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Cancel appointment
        window.cancelAppointment = function(id) {
            showModal('Cancel this appointment?', () => {
                const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
                const updated = appointments.map(apt => apt.id === id ? { ...apt, status: 'Cancelled' } : apt);
                localStorage.setItem('appointments', JSON.stringify(updated));
                displayAppointments();
                showToast('Appointment cancelled');
                logActivity('Cancelled appointment');
                updateRecentAppointments();
            });
        };

        // Generate PDF
        function generatePDF(appointment) {
            const doc = new jsPDF();
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.addImage('s1.png', 'PNG', 15, 10, 20, 20);
            doc.text('Legal Connect', 35, 15);
            doc.setFontSize(12);
            doc.text('Appointment Confirmation', 15, 35);
            doc.setFontSize(10);
            doc.text(`Name: ${userData.name}`, 15, 45);
            doc.text(`Lawyer: ${appointment.lawyer}`, 15, 50);
            doc.text(`Location: ${appointment.location}`, 15, 55);
            doc.text(`Case Type: ${appointment.caseType}`, 15, 60);
            doc.text(`Date & Time: ${new Date(appointment.dateTime).toLocaleString()}`, 15, 65);
            let yOffset = 65;
            if (appointment.conferenceMethod) {
                yOffset += 5;
                doc.text(`Conference Method: ${appointment.conferenceMethod}`, 15, yOffset);
            }
            if (appointment.notes) {
                yOffset += 5;
                doc.text('Notes:', 15, yOffset);
                doc.text(doc.splitTextToSize(appointment.notes, 170), 15, yOffset + 5);
                yOffset += 10;
            }
            doc.setFontSize(8);
            doc.text('Generated on May 23, 2025', 15, 280);
            currentAppointment.pdfData = doc.output('datauristring');
            doc.save(`Appointment_${appointment.id}.pdf`);
        }

        // PDF preview
        document.getElementById('previewPDFBtn').addEventListener('click', () => {
            showScreen('pdfPreviewScreen');
            const preview = document.getElementById('pdfPreview');
            preview.innerHTML = '';
            const pdfContent = document.createElement('div');
            pdfContent.style.cssText = 'padding: 10px; background: white; color: black; font-family: Helvetica, sans-serif; font-size: 10px;';
            pdfContent.innerHTML = `
                <img src="s1.png" style="width: 20px; height: 20px;">
                <h1 style="font-size: 12px; margin: 5px 0;">Legal Connect</h1>
                <h2 style="font-size: 10px;">Appointment Confirmation</h2>
                <p><strong>Name:</strong> ${userData.name}</p>
                <p><strong>Lawyer:</strong> ${currentAppointment.lawyer}</p>
                <p><strong>Location:</strong> ${currentAppointment.location}</p>
                <p><strong>Case Type:</strong> ${currentAppointment.caseType}</p>
                <p><strong>Date & Time:</strong> ${new Date(currentAppointment.dateTime).toLocaleString()}</p>
                ${currentAppointment.conferenceMethod ? `<p><strong>Conference Method:</strong> ${currentAppointment.conferenceMethod}</p>` : ''}
                ${currentAppointment.notes ? `<p><strong>Notes:</strong> ${currentAppointment.notes}</p>` : ''}
                <p style="font-size: 8px; position: absolute; bottom: 0;">Generated on May 23, 2025</p>
            `;
            preview.appendChild(pdfContent);
            html2canvas(pdfContent, { scale: 2 }).then(canvas => {
                preview.innerHTML = '';
                preview.appendChild(canvas);
            });
        });
        document.getElementById('downloadPDFBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = currentAppointment.pdfData;
            link.download = `Appointment_${currentAppointment.id}.pdf`;
            link.click();
        });
        document.getElementById('backPDFBtn').addEventListener('click', () => showScreen('confirmationScreen'));

        // Recent appointments
        function updateRecentAppointments() {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const recent = appointments.slice(-2);
            const list = document.getElementById('recentAppointments');
            list.innerHTML = '';
            recent.forEach(apt => {
                const div = document.createElement('div');
                div.className = 'p-1 border-b';
                div.innerHTML = `
                    <p class="text-xs"><strong>${apt.lawyer}</strong> - ${apt.caseType}</p>
                    <p class="text-xs">${new Date(apt.dateTime).toLocaleString()}</p>
                `;
                list.appendChild(div);
            });
        }

        // Export appointments as CSV
        document.getElementById('exportAppointmentsBtn').addEventListener('click', () => {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const csv = ['ID,Lawyer,Location,Case Type,Date,Method,Notes,Status'];
            appointments.forEach(apt => {
                csv.push(`${apt.id},${apt.lawyer},${apt.location},${apt.caseType},${new Date(apt.dateTime).toLocaleString()},${apt.conferenceMethod || ''},${apt.notes || ''},${apt.status}`);
            });
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Appointments.csv';
            link.click();
            logActivity('Exported appointments as CSV');
        });

        // Navigation
        document.getElementById('viewAppointmentsBtn').addEventListener('click', () => {
            showScreen('appointmentsScreen');
            displayAppointments();
        });

        // Floating action button
        document.getElementById('fab').addEventListener('click', () => showScreen('dashboardScreen'));

        // Search and filter appointments
        document.getElementById('searchAppointments').addEventListener('input', displayAppointments);
        document.getElementById('filterAppointments').addEventListener('change', displayAppointments);

        // Activity logging
        function logActivity(action) {
            const logs = JSON.parse(localStorage.getItem('activityLogs')) || [];
            logs.push({ action, timestamp: new Date().toISOString() });
            if (logs.length > 50) logs.shift();
            localStorage.setItem('activityLogs', JSON.stringify(logs));
        }

        // HTML escaping
        function escapingHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            updateRecentAppointments();
            if (userData) {
                showScreen(localStorage.getItem('lastScreen') || 'dashboardScreen');
            }
        });
    </script>
</body>
</html>
